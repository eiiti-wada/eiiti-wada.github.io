<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>15 puzzle anim</title>
  <style>
canvas {  border: solid 1px #999;}
  </style>
</head>
 
<body>
  <a onclick="initialize()">
  <canvas id="mycanvas" width="300" height="500"></canvas> 
  <script>
var canvas = document.getElementById("mycanvas");
var context = canvas.getContext("2d");
var bs=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,0];
var pzero=15,mvs=[],m,mvsp=0;
var running=false,debug=false;
var repcount=0,nexttab=[];
var intervalID;
var shs=[];
function pop(){//alert(mvsp+" "+mvs);
mvsp--;m=mvs[mvsp];}	       
function concat(as){
var al=as.length;
for(i=0;i<al;i++){mvs[i+mvsp]=as[i];}
mvsp=mvsp+al;}
function see(a) {if(debug){alert(a);}}
function str(x) {return ('  '+x).slice(-2);}				 
function listcopy(a){
var b =[];
for(var i=0;i<a.length;i++){b.push(a[i]);}
return b;}
function center(s,x,y,f,c){
context.font = f; //"15px serif"
context.fillStyle = c; //"#000000"
var metrics = context.measureText(s);
context.fillText(s,x-metrics.width/2,y);}
function divmod(n,d){
return [Math.floor(n/d),n-d*Math.floor(n/d)];}
var dt=5;
var ds=[4,-1,-4,1];
function next(d){
if(d>=0){//alert("next "+d);
pzero=bs.indexOf(0);swap(pzero,pzero+ds[d]);pzero=bs.indexOf(0);/*alert("next "+d+" : " +bs );*/}}
var moves=[[1,1,1,2,2,2,3,3,3,0,0,0],[1,1,2,2,3,3,0,0],
[1,2,3,0],[2,1,0,3],[2,2,1,1,0,0,3,3],[2,2,2,1,1,1,0,0,0,3,3,3]];	       

function slide(ds){alert("slide "+ds);	   
 mvs=listcopy(ds);alert("setInt");intervalID=setInterval(draw,30);}
	       
function draw() {
context.clearRect(0,0,300,500);


context.beginPath();
context.strokeStyle="#0000ff";
context.lineWidth=4.5;
context.moveTo(30,15);
context.lineTo(30+4*mvsp,15);
context.stroke();
context.beginPath();
context.strokeStyle="#000000";
context.lineWidth=1.5;
for(y=270;y<=390;y=y+40){
      for(x=30;x<=230;x=x+40){context.strokeRect(x,y,40,40);}}
context.lineWidth=1.5;
context.moveTo(70,430);context.lineTo(70,350);context.lineTo(230,350);
context.lineTo(230,430);context.moveTo(110,430);context.lineTo(110,390);
context.lineTo(190,390);context.lineTo(190,430);
context.stroke();		  
context.lineWidth=1;		  
for(x=30;x<=190;x=x+80){context.strokeRect(x,430,80,40);}
for(n=0;n<6;n++){
center(["a","b","c","c","b","a"][n],50+40*n,292,"24px serif","#000000");
center(["+","+","+","-","-","-"][n],50+40*n,310,"24px serif","#000000");}

for(y=340;y<=420;y=y+40){
	     center("+1",130,y,"24px serif","#000000");
	     center("-1",170,y,"24px serif","#000000");}
for(y=340;y<=380;y=y+40){
	     center("+2",90,y,"24px serif","#000000");
	     center("-2",210,y,"24px serif","#000000");}
for(n=0;n<3;n++){
center(["+3","+4","+5"][n],50,40*n+340,"24px serif","#000000");
center(["-3","-4","-5"][n],250,40*n+340,"24px serif","#000000");}
center("+3",90,420,"24px serif","#000000");
center("-3",210,420,"24px serif","#000000");	     
center("reset",70,460,"22px serif","#000000");
center("shuf-",150,450,"22px serif","#000000");
center("fle",150,468,"22px serif","#000000");
center("solve",230,460,"22px serif","#000000");

if(mvsp>0){center(str(shs.length),15,20,"22px serif","#000000");}

context.save();
context.translate(30,30);
for(var n=0;n<=15;n++) {
  var p=bs[n];
  var i=Math.floor(n/4),j=n%4;
  if(p==0){context.fillStyle="#c0c0c0";}
  else{if(((p-1)%4+Math.floor((p-1)/4))%2==1)
	       {context.fillStyle="#00ff00";}
	       else{context.fillStyle="#ffffff";}}
  context.fillRect(j*60,i*60,60,60);
  if(p>0)
  {center(str(p),j*60+30,i*60+45,"32px serif","#000000");}}
context.lineWidth=3;
context.strokeStyle="#000000";
for(var i=0;i<=240;i=i+60){
context.moveTo(0,i);
context.lineTo(240,i);
context.moveTo(i,0);
context.lineTo(i,240);}
context.stroke();
context.restore();

if(mvsp>0){pop();
  if(10<=m){concat(macro0[m-10]);pop();}
  if(4<=m){concat(macro1[m-4]);pop();}
  if(m==-1){alert(bs);}else{next(m);}}
else{clearInterval(intervalID);}
	  }
		
function reset(){
bs=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,0];
pzero=15;
draw();}

function doKeyDown(evt) {//alert(evt.keyCode);
var ch=evt.keyCode;
var key=bs.indexOf(0);
var i=Math.floor(key/4),j=key%4;
if(ch==76&&j<3){swap(key,key+1);}  //L
if(ch==85&&i<3){swap(key,key+4);}  //U
if(ch==82&&j>=1){swap(key,key-1);}  //R
if(ch==68&&i>=1){swap(key,key-4);} //D
if(ch==32){alert("x");mvs=[1,1,2,2,3,3,0,0];intervalID=setInterval(draw,30);}
	 if(ch==65){spacereset();}
	 draw();}


function swap(i,j){//alert("swap "+i+" "+j);
 var t=bs[i];bs[i]=bs[j];bs[j]=t;}
function swap2(i,j){var t=bs2[i];bs2[i]=bs2[j];bs2[j]=t;}

function getPosition(event){
       var x = new Number();
       var y = new Number();
       var canvas = document.getElementById("mycanvas");
       if (event.x != undefined && event.y != undefined)  {
         x = event.x;
         y = event.y;     }
        else{ // Firefox method to get the position
         x = event.clientX + document.body.scrollLeft +
             document.documentElement.scrollLeft;
         y = event.clientY + document.body.scrollTop +
             document.documentElement.scrollTop;  }
        x -= canvas.offsetLeft;
        y -= canvas.offsetTop;
	   x0=x-30;y0=y-30;
key=-1;

if(x0<0&&y0<0){bs=[1,10,15,4,13,6,3,8,2,9,12,7,14,5,0,11];draw();}
if(x0>=240&&y0<0){mvsp=0;concat(solution);intervalID=setInterval(draw,30);}
 for(n=0;n<16;n++) {
 var i=Math.floor(n/4),j=n%4;
 if(j*60<=x0&&x0<(j+1)*60&&i*60<=y0&&y0<(i+1)*60){key=n;}}

for(i=0;i<5;i++){
for(j=0;j<6;j++){
if(j*40<=x0&&x0<j*40+40&&i*40+240<=y0&&y0<i*40+280)
   {key=i*6+j+16;}}}


if(0<=key && key<16)     //single cell slide
{var i=Math.floor(key/4),j=key%4;

if(j<3&&bs[key+1]==0){swap(key,key+1);}
if(i<3&&bs[key+4]==0){swap(key,key+4);}
if(j>=1&&bs[key-1]==0){swap(key,key-1);}
if(i>=1&&bs[key-4]==0){swap(key,key-4);}
draw();}

else if(16<=key&&key<22&&bs.indexOf(0)==15){  //sigle loop
mvsp=0;shs=macro1[key-16];concat(shs);pzero=15;intervalID=setInterval(draw,30);}

if(22<=key&&key<40){   //multi loop
var index=[2,3,4,5,6,7,1,11,12,13,14,8,0,10,16,17,15,9][key-22];
mvsp=0;shs=macro0[index];concat(shs);
pzero=15;intervalID=setInterval(draw,30);}			      

else if(Math.floor(key/2)==20){reset();}
else if(Math.floor(key/2)==21){shuffle();
 mvsp=0;concat(shs.reverse());clearInterval(intervalID);
 pzero=bs.indexOf(0);intervalID=setInterval(draw,30);}
else if(Math.floor(key/2)==22){lgsolve();clearInterval(intervalID);
mvsp=0;concat(shs);intervalID=setInterval(draw,30);}      
}
     function arrayRemove(arr,val){
     return arr.filter(function(ele){
     return ele != val;});}


var neigs=[[1,4],[0,2,5],[1,3,6],[2,7],[0,5,8],[1,4,6,9],[2,5,7,10],
[3,6,11],[4,9,12],[5,8,10,13],[6,9,11,14],[7,10,15],[8,13],
[9,12,14],[10,13,15],[11,14]];

function shuffle(){
shs=[];var oldbs=listcopy(bs);pzero=bs.indexOf(0);
var newp=pzero;
var olds=neigs[newp];
var oldp=olds[getRandomInt(olds.length)];
for(i=0;i<30;i++){
olds=arrayRemove(neigs[newp],oldp);
oldp=newp;
newp=olds[getRandomInt(olds.length)];
shs.push(ds.indexOf(newp-oldp));
		//		   alert("swap "+newp+" "+oldp);
	   swap(newp,oldp);
				   pzero=newp;//alert(bs+":::"+pzero);
	   }
/*alert(shs);*/bs=listcopy(oldbs);}

var macro0=[[4,4,4,4,4],[4,4,4,4],[4,4,4],[4,4],[4],
           [9],[9,9],[9,9,9],[9,9,9,9],[9,9,9,9,9],
           [5,5,5],[5,5],[5],[8],[8,8],[8,8,8],[6],[7]];
var macro1=[[0,0,0,3,3,3,2,2,2,1,1,1],[0,0,3,3,2,2,1,1],[0,3,2,1],
           [3,0,1,2],[3,3,0,0,1,1,2,2],[3,3,3,0,0,0,1,1,1,2,2,2]];
var solution=[23,26,22,24,26,21,27,25,26,20,24,27,21,20,26,25,24,27,
21,15,20,14,16,20,13,17,21,12,18,21,11,19,22,10,16,23,13,10,20,19,3];
//var solution2=
//[3,19,20,10,13,23,16,10,22,19,11,21,18,12,21,17,13,20,16,14,20,15,
// 21,27,24,25,26,20,21,27,24,20,26,25,27,21,26,24,22,26,23];

function getRandomInt(max){
 return Math.floor(Math.random()*max);}
function initialize()
 {var canvas = document.getElementById("mycanvas");
      canvas.addEventListener("mousedown", getPosition, false);
      window.addEventListener('keydown',doKeyDown,true);
//	       bs=[9,10,8,3,4,14,15,5,6,12,1,2,7,13,11,0];
      }

//これ以後loop generator solve 
function a(n){//alert("a rotate "+n);
shs.push([12,11,10,19,18,17,16,15,,14,13,12,11,10,19,18,17][n+8]);
rotate(atab[(11-n)%11]);}			    
function b(n){//alert("b rotate "+n);
shs.push([21,20,25,24,23,,22,21,20,25,24][n+5]);
rotate(btab[(7-n)%7]);}
function c(n){//alert("c rotate "+n);
shs.push([27,,26][n+1]);
rotate(ctab[(3-n)%3]);}		       
 
function spacereset() {//alert("spacereset");
var ij=divmod(bs.indexOf(0),4);
for(j=3;j>ij[1];j--){shs.push(3);next(3);}
for(i=3;i>ij[0];i--){shs.push(0);next(0);}
}
var atab=[
[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14],
[4,0,1,2,8,5,6,3,12,9,10,7,13,14,11],
[8,4,0,1,12,5,6,2,13,9,10,3,14,11,7],
[12,8,4,0,13,5,6,1,14,9,10,2,11,7,3],
[13,12,8,4,14,5,6,0,11,9,10,1,7,3,2],
[14,13,12,8,11,5,6,4,7,9,10,0,3,2,1],
[11,14,13,12,7,5,6,8,3,9,10,4,2,1,0],
[7,11,14,13,3,5,6,12,2,9,10,8,1,0,4],
[3,7,11,14,2,5,6,13,1,9,10,12,0,4,8],
[2,3,7,11,1,5,6,14,0,9,10,13,4,8,12],
[1,2,3,7,0,5,6,11,4,9,10,14,8,12,13]];
var btab=[
[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14],
[0,1,2,3,4,9,5,6,8,13,10,7,12,14,11],
[0,1,2,3,4,13,9,5,8,14,10,6,12,11,7],
[0,1,2,3,4,14,13,9,8,11,10,5,12,7,6],
[0,1,2,3,4,11,14,13,8,7,10,9,12,6,5],
[0,1,2,3,4,7,11,14,8,6,10,13,12,5,9],
[0,1,2,3,4,6,7,11,8,5,10,14,12,9,13]];
var ctab=[
[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14],
[0,1,2,3,4,5,6,7,8,9,14,10,12,13,11],
[0,1,2,3,4,5,6,7,8,9,11,14,12,13,10]];
var ps0=[4,3,2,1,5,9,13],qs0=[3,2,1,0,4,8,12];
var ps1=[8,7,6,10,14],qs1=[7,6,5,9,13];

function rotate(tb){//alert("rot tb "+tb);
var b=[];
for(j=0;j<15;j++){
b[j]=bs[tb[j]];}
bs=b;bs[15]=0;//alert("bs "+bs);
}	   

function lgsolve(){//alert("lgsolve");  
var bsback=listcopy(bs);
shs=[];
spacereset();
var l=0;for(i=0;i<7;i++){
var p=ps0[i],q=qs0[i];
var r=bs.indexOf(p);// alert("ipqr "+i+" "+p+" "+q+" "+r);
if(q!=r){
switch(r){
case 7:b(2);r=5;break;
case 11:c(1);r=10;break;
case 14:c(-1);r=10;break;
case 13:b(-2);r=5;break;
case 0:case 1:case 2:case 3:case 4:case 8:case 12:
l=7-qs0.indexOf(r);  // 1<=l<=7
a(l);b(-1);a(- l);r=9;break;}
//alert("aloop stage 2");
if(r==10){
l=8-i;a(l);c(1);a(- l);}
else{
l=7-i;a(l);b([0,9,5,6].indexOf(r));a(- l);}}}
//alert("bloop");
for(i=0;i<5;i++){
var p=ps1[i],q=qs1[i];
var r=bs.indexOf(p);// alert("ipqr "+i+" "+p+" "+q+" "+r);
if(r!=q){switch(r){
case 11:c(1);break;
case 14:c(-1);break;
case 7:case 6:case 5:case 9:case 13:
l=5-qs1.indexOf(r);  // 1<=l<=5
b(l);c(-1);b(- l);break;}
//alert("bloop stage 2");
l=5-i;b(l);c(1);b(- l);}}
r=bs.indexOf(11);
if(r==11){c(1);}
if(r==14){c(-1);}
shs=shs.reverse();		      
pzero=bs.indexOf(0);//alert(shs.length);
//alert(shs.slice(0,10));alert(shs.slice(10,20));alert(shs.slice(20,30));
//alert(shs.slice(30,40));alert(shs.slice(40,50));alert(shs.slice(50,60));
draw();//alert("old ps");
bs=listcopy(bsback);draw();/*alert("solve");*/
}
   
initialize();

/*function lg(tab){var b=[];
for(i=0;i<16;i++){
b.push(bs[tab[i]]);}	   
bs=listcopy(b);}*/
/*
var ap1=[1,2,3,7,0,5,6,11,4,9,10,14,8,12,13,15];
var am1=[4,0,1,2,8,5,6,3,12,9,10,7,13,14,11,15];
var bp1=[0,1,2,3,4,6,7,11,8,5,10,14,12,9,13,15];
var bm1=[0,1,2,3,4,9,5,6,8,13,10,7,12,14,11,15];
var cp1=[0,1,2,3,4,5,6,7,8,9,11,14,12,13,10,15];
var cm1=[0,1,2,3,4,5,6,7,8,9,14,10,12,13,11,15];
*/

	   /*alert("start");
	   mvs=[];
	   for(i=0;i<5;i++){mvs=mvs.concat(moves[0]);}
           mvs=mvs.concat([-1]);
      		      for(i=0;i<5;i++){mvs=mvs.concat(moves[5]);}
slide(mvs);alert("p0");*/

//slide([1,1,1,2,2,2]);alert("p1");
//slide([3,3,3,0,0,0]);alert("p2");
//slide(mvs);
	      //intervalID=setInterval(draw,30);
				 draw();
				 
</script>	       </body>
</html>


